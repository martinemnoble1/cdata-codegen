FROM node:20-alpine3.20 AS builder

ARG NEXT_PUBLIC_AAD_CLIENT_ID
ARG NEXT_PUBLIC_AAD_TENANT_ID
ARG NEXT_PUBLIC_REQUIRE_AUTH=true
ENV NEXT_PUBLIC_AAD_CLIENT_ID=$NEXT_PUBLIC_AAD_CLIENT_ID
ENV NEXT_PUBLIC_AAD_TENANT_ID=$NEXT_PUBLIC_AAD_TENANT_ID
ENV NEXT_PUBLIC_REQUIRE_AUTH=$NEXT_PUBLIC_REQUIRE_AUTH

WORKDIR /app

# Copy package files from client directory
COPY package*.json ./

# Install all dependencies (including devDependencies for building) with retry logic
RUN npm config set fetch-retry-mintimeout 20000 && \
    npm config set fetch-retry-maxtimeout 120000 && \
    npm config set fetch-retries 5 && \
    npm ci --verbose || (npm cache clean --force && npm ci --verbose)

# Copy source code from client directory
COPY . .

# Build for web (from client root directory as originally intended)
RUN npx cross-env BUILD_TARGET=web npm run copy-assets

RUN cp package.json renderer/

RUN cd renderer && npx next build

FROM node:20-alpine3.20 AS runner

WORKDIR /app

# Add curl for health checks
RUN apk add --no-cache curl

# Copy the built application
COPY --from=builder /app/renderer ./renderer
COPY --from=builder /app/package*.json ./

# Install production dependencies only
RUN npm ci --omit=dev && npm cache clean --force

# Create a non-root user
RUN addgroup -g 1001 -S nodejs
RUN adduser -S nextjs -u 1001

# Change ownership of the app directory
RUN chown -R nextjs:nodejs /app
USER nextjs

EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=30s --retries=3 \
    CMD curl -f http://localhost:3000/ || exit 1

# Use ENTRYPOINT with CMD for better Azure Container Apps compatibility
ENTRYPOINT ["sh", "-c"]
CMD ["cd renderer && exec npx next start"]
