services:
  # PostgreSQL Database - Prepared for external database migration
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: ${DB_NAME:-ccp4i2}
      POSTGRES_USER: ${DB_USER:-ccp4i2}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-ccp4i2_secure_password}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "${DB_PORT:-5432}:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_USER:-ccp4i2}"]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - backend

  # Django Server - Production ready with Uvicorn
  server:
    build:
      context: ../server
      dockerfile: ../Docker/Dockerfile.server
      platforms:
        - linux/amd64
    platform: linux/amd64

    environment:
      - DEBUG=${DEBUG:-false}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1,nginx,web,server}
      - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:3003,http://web:3003,http://nginx}
      - SECRET_KEY=${DJANGO_SECRET_KEY:-your-secret-key-here}
      - CCP4_DATA_PATH=${CCP4_DATA_PATH:-/mnt/ccp4data}
      - UVICORN_WORKERS=${UVICORN_WORKERS:-2}
      - UVICORN_HOST=${UVICORN_HOST:-0.0.0.0}
      - UVICORN_PORT=${UVICORN_PORT:-8000}
      - DB_HOST=${DB_HOST:-db}
      - DB_USER=${DB_USER:-ccp4i2}
      - DB_PASSWORD=${DB_PASSWORD:-ccp4i2_password}
      - DB_NAME=${DB_NAME:-ccp4i2}
      - DB_SSL_MODE=${DB_SSL_MODE:-disable}
    volumes:
      - static_files:/usr/src/app/staticfiles
      - media_files:/usr/src/app/media
      - ${CCP4_DATA_HOST_PATH:-/Users/nmemn/Developer/ccp4data}:/mnt/ccp4data:rw
    ports:
      - "${SERVER_PORT:-8000}:8000"
    depends_on:
      db:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 120s # Longer start period for requirements installation
    restart: unless-stopped
    networks:
      - backend
      - frontend
    labels:
      - "app.service=ccp4i2-server"
      - "app.environment=${ENVIRONMENT:-development}"

  # Next.js Web Client - Production optimized
  web:
    build:
      context: ../client
      dockerfile: ../Docker/Dockerfile.web
    environment:
      - NODE_ENV=${NODE_ENV:-production}
      - NEXT_PUBLIC_API_BASE_URL=http://server:8000
      - NEXT_PUBLIC_IS_ELECTRON=false
      - BUILD_TARGET=web
      - PORT=${WEB_PORT:-3003}
    ports:
      - "${WEB_PORT:-3003}:${WEB_PORT:-3003}"
    depends_on:
      - server
    healthcheck:
      test:
        [
          "CMD",
          "curl",
          "-f",
          "http://localhost:${WEB_PORT:-3003}/api/proxy/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    restart: unless-stopped
    networks:
      - frontend
    labels:
      - "app.service=ccp4i2-web"
      - "app.environment=${ENVIRONMENT:-development}"
    command: >
      sh -c "
        cd /app/renderer &&
        echo 'Starting Next.js Web Client...' &&
        npx next start -p ${WEB_PORT:-3003}
        "

  # Nginx Reverse Proxy - Cloud-ready load balancer
  nginx:
    image: nginx:alpine
    ports:
      - "${NGINX_HTTP_PORT:-80}:80"
      - "${NGINX_HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - static_files:/usr/share/nginx/html/static:ro
      - media_files:/usr/share/nginx/html/media:ro
      - ${SSL_CERT_PATH:-./nginx/ssl}:/etc/nginx/ssl:ro
      - /Users/nmemn/Developer/ccp4data/home/user:/home/user
    depends_on:
      - server
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost/health",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
    restart: unless-stopped
    networks:
      - frontend
    labels:
      - "app.service=ccp4i2-nginx"
      - "app.environment=${ENVIRONMENT:-development}"

  # Management Service - Updated to use CCP4 Python
  management:
    build:
      context: ../server
      dockerfile: ../Docker/Dockerfile.server
      platforms:
        - linux/amd64
    platform: linux/amd64
    environment:
      - DEBUG=${DEBUG:-false}
      - DATABASE_URL=postgresql://${DB_USER:-ccp4i2}:${DB_PASSWORD:-ccp4i2_password}@db:${DB_PORT:-5432}/${DB_NAME:-ccp4i2}
      - ALLOWED_HOSTS=${ALLOWED_HOSTS:-localhost,127.0.0.1}
      - DJANGO_SETTINGS_MODULE=ccp4x.config.settings
    volumes:
      - static_files:/usr/src/app/staticfiles
      - media_files:/usr/src/app/media
      - ${CCP4_DATA_HOST_PATH:-/Users/nmemn/Developer/ccp4data}:/mnt/ccp4data
    depends_on:
      db:
        condition: service_healthy
    networks:
      - backend
    profiles:
      - management
    command: >
      sh -c "
        echo 'Waiting for CCP4 data volume...' &&
        timeout=60 &&
        while [ ! -f /mnt/ccp4data/ccp4-9/BINARY.setup] && [ $$timeout -gt 0 ]; do
          echo 'BINARY.setup script not found, waiting... ($$timeout seconds remaining)'
          sleep 5
          timeout=$$((timeout-5))
        done &&
        if [ ! -f /mnt/ccp4data/ccp4-9/BINARY.setup ]; then
          echo 'ERROR: BINARY.setup script not found'
          exit 1
        fi &&
        echo 'Preparing CCP4 environment...' &&
        /mnt/ccp4data/ccp4-9/BINARY.setup --run-from-script &&
        while [ ! -f /mnt/ccp4data/ccp4-9/bin/ccp4.setup-sh ] && [ $$timeout -gt 0 ]; do
          echo 'CCP4 setup script not found, waiting... ($$timeout seconds remaining)'
          sleep 5
          timeout=$$((timeout-5))
        done &&
        if [ ! -f /mnt/ccp4data/ccp4-9/bin/ccp4.setup-sh ]; then
          echo 'ERROR: CCP4 setup script not found'
          exit 1
        fi &&
        echo 'Loading CCP4 environment...' &&
        . /mnt/ccp4data/ccp4-9/bin/ccp4.setup-sh &&
        CCP4_PYTHON=/mnt/ccp4data/ccp4-9/bin/ccp4-python &&
        if [ ! -f /tmp/ccp4-requirements-installed ]; then
          echo 'Installing requirements for management service...' &&
          $$CCP4_PYTHON -m pip install --upgrade pip &&
          $$CCP4_PYTHON -m pip install -r requirements.txt &&
          $$CCP4_PYTHON -m pip install 'uvicorn[standard]' &&
          touch /tmp/ccp4-requirements-installed
        fi &&
        echo 'Management service ready. Available commands:' &&
        echo '  docker-compose exec management /mnt/ccp4data/ccp4-9/bin/ccp4-python manage.py shell' &&
        echo '  docker-compose exec management /mnt/ccp4data/ccp4-9/bin/ccp4-python manage.py migrate' &&
        echo '  docker-compose exec management /mnt/ccp4data/ccp4-9/bin/ccp4-python manage.py createsuperuser' &&
        echo '  docker-compose exec management /mnt/ccp4data/ccp4-9/bin/ccp4-python manage.py collectstatic' &&
        tail -f /dev/null
      "

volumes:
  postgres_data:
    driver: local
    labels:
      - "app.volume=database"
  static_files:
    driver: local
    labels:
      - "app.volume=static"
  media_files:
    driver: local
    labels:
      - "app.volume=media"

networks:
  frontend:
    driver: bridge
    labels:
      - "app.network=frontend"
  backend:
    driver: bridge
    labels:
      - "app.network=backend"
